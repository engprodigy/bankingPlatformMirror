function pullSecondaryData(){$.ajax(url_path+"/../../Setup/LoadChequeCharges").then(function(response){$.each(response,function(index,item){item.isdiscountcharge?DiscountChargeObj=item:ReturnChargeObj=item})});$.ajax(url_path+"/../../Setup/LoadCOT").then(function(response){COTObj=response.length==0?null:response[0]})}function initDataTable(){$("#inward-cheque-table").bootstrapTable({})}function initDatePicker(){$(".datepicker").length!=0&&$(".datepicker").datetimepicker({format:"YYYY-MM-DD",icons:{time:"now-ui-icons tech_watch-time",date:"now-ui-icons ui-1_calendar-60",up:"fa fa-chevron-up",down:"fa fa-chevron-down",previous:"now-ui-icons arrows-1_minimal-left",next:"now-ui-icons arrows-1_minimal-right",today:"fa fa-screenshot",clear:"fa fa-trash",close:"fa fa-remove"}})}function initSelectTwoConfig(){$.fn.select2.defaults.set("theme","bootstrap4");$.fn.select2.defaults.set("dropdownParent",$(".modal").first());$.fn.select2.defaults.set("width","100%");$.fn.select2.defaults.set("allowClear",!0);var form=$("#inward-cheque-form");$.ajax(url_path+"/../../Setup/LoadChartOfAccount").then(function(response){var responseDate=response;form.find("#chargeglid").select2({placeholder:"Select ledger",data:response});$.each(response,function(index,item){chartofaccounts[item.id]=item.text});initDataTable()});$.ajax(url_path+"/../LoadCurrentAccounts").then(function(response){form.find("#casaaccountno").select2({placeholder:"Select account number",data:response})});$.ajax(url_path+"/../LoadInwardCheques").then(function(response){inwardbankcheque={};$.each(response,function(index,item){inwardbankcheque[item.casaaccountno]=item.principalglid})});$.ajax(url_path+"/../LoadProducts").then(function(response){$.each(response,function(index,item){products[item.id]=item})});$(document).on("select2:open",function(){$(".select2-results__options").perfectScrollbar()})}function initEventListeners(){var form=$("#inward-cheque-form");form.find("#casaaccountno").on("select2:select",function(e){utilities.clearDetails();var casaccountNumber=e.params.data.id,productId;$.ajax(url_path+"/../LoadCASAMandates/"+e.params.data.id).then(function(response){AccountObj={};AccountObj.name=response.accountName;AccountObj.number=response.accountNumber;AccountObj.balance=response.availableBalance;productId=response.ProductID;form.find("#amount").removeAttr("disabled");form.find("#amount").trigger("change");form.find("#accountno").text(response.accountNumber);form.find("#accountname").text(response.accountName);utilities.WriteAmount(Number(response.availableBalance),form.find("#balance"));form.find("#productname").text(utilities.getProductName(response.productID))});$.ajax(url_path+"/../LoadPrincipalGlId/"+e.params.data.id).then(function(response){form.find("#principalglid").val(chartofaccounts[response]);$("#casa-mandate-table").bootstrapTable("load",utilities.filterMandates(response.tblMandate))});$.ajax(url_path+"/../LoadDetailedAccountCheques/"+e.params.data.id).then(function(response){AccountCheques=[];AccountChequeLeaves={stopped:[],used:[]};$.each(response,function(i,item){AccountCheques.push([item.startrange,item.endrange]);$.each(item.tblChequeleavesdetail,function(i,obj){obj.leafstatusNavigation.status=="STOPPED"?AccountChequeLeaves.stopped.push(obj.leafno):AccountChequeLeaves.used.push(obj.leafno)})})},function(){AccountCheques=null;AccountChequeLeaves=null;swal({title:"Validate Cheque No.",type:"error",text:"There was an error loading account cheques!"})})}).on("select2:unselect",function(){AccountObj=undefined;utilities.clearDetails();form.find("#amount").val("").attr("disabled",!0).trigger("change")});form.find("#otherreturn").on("change",function(){utilities.clearCheckBoxes();this.checked?$(".charges-control").slideUp():$(".charges-control").slideDown()});form.find("#discount").on("change",function(){this.checked&&utilities.initChargeBox("Discount")});form.find("#return").on("change",function(){this.checked&&utilities.initChargeBox("Return")});form.find("#amountdifference").on("change",function(){var form=$("#inward-cheque-form"),value=UnFormatMoney(this.value);value<0?(utilities.enableDisableOtherReturn(!0,form.find("#otherreturn")),$(".charges-control").slideDown(),(form.find("#discount").prop("checked")||form.find("#return").prop("checked"))&&form.find("#chargepercent").trigger("change")):(utilities.enableDisableOtherReturn(!1,form.find("#otherreturn")),$(".charges-control").slideUp())});form.find("#amount").on("change",function(){var form=$("#inward-cheque-form"),value=$.trim(this.value).replace(/,/g,"");if($.isNumeric(value))if(Number(value)<=0)this.value="",$.notify({icon:"now-ui-icons travel_info",message:"Cheque amount must exceed 0!"},{type:"danger",placement:{from:"top",align:"right"}});else{if(ChequeAmount=Number(value),utilities.ChargeCOTSwitch(!0),form.find(".charges-control, .charges-control > .form-check").removeClass("disabled"),form.find(".charges-control input").removeAttr("disabled"),form.find("#chargecot").prop("checked")){utilities.WriteCOTAmount(!0);return}return AmountDifference=Number(ChequeAmount),utilities.WriteInputAmount(AmountDifference,form.find("#amountdifference"))}utilities.ChargeCOTSwitch(!1);form.find(".charges-control, .charges-control > .form-check").addClass("disabled");form.find(".charges-control input").attr("disabled",!0);utilities.WriteInputAmount(0,form.find("#amountdifference"))});form.find("#chargecot").on("change",function(){if(this.checked&&COTObj==null)return utilities.WriteCOTAmount(!1),form.find("#chargecot").prop("checked",!1),$.notify({icon:"now-ui-icons travel_info",message:"Cannot enable COT charge because COT setup have not been completed!"},{type:"danger",placement:{from:"top",align:"right"}});utilities.WriteCOTAmount(this.checked)});form.find("#chargepercent").on("change",utilities.calculateChargeAmount)}function initFormValidations(){jQuery.validator.setDefaults({onfocusout:!1,onkeyup:!1,onclick:!1,normalizer:function(value){return $.trim(value)},errorPlacement:function(error){$.notify({icon:"now-ui-icons travel_info",message:error.text()},{type:"danger",placement:{from:"top",align:"right"}})}});$("#inward-cheque-form").validate({rules:{amount:{number:!0},chargepercent:{number:!0}},messages:{casaaccountno:{required:"Please select an account"},amount:{required:"Please insert an amount",number:"Amount is not a valid number"},chequeno:{required:"Cheque number is required"},principalglid:{required:"Please select principal ledger"},discountgl:{required:"Please select discount ledger"},transactiondate:{required:"Transaction date is required"},chargepercent:{required:"Charge rate is required",number:"Charge rate is not a valid number"},chargeglid:{required:"Charge ledger must be selected"},"charge-type":{required:"One of the charge types must be selected"}},ignore:":hidden:not(.always-validate)"})}function openNewModal(){$("#inwardChequeModal").modal("show")}function runValidations(){var isUsedCheque;if(AccountCheques==null||AccountChequeLeaves==null)return swal({title:"Cheque Validations",type:"error",text:"There was an error loading account cheques' information! Please refresh and try again."}),!1;for(var form=$("#inward-cheque-form"),chequeno=Number(form.find("#chequeno").val()),isOtherReturnCheque=form.find("#otherreturn").prop("checked"),chequeExists=!1,index=0,len=AccountCheques.length;index<len;++index)if(chequeno>=AccountCheques[index][0]&&chequeno<=AccountCheques[index][1]){chequeExists=!0;break}return chequeExists?$.inArray(chequeno,AccountChequeLeaves.stopped)!==-1?(swal({title:"Inward Cheque Clearing",type:"error",text:"The supplied cheque number has been stopped!"}),!1):(isUsedCheque=$.inArray(chequeno,AccountChequeLeaves.used)!==-1,isOtherReturnCheque&&!isUsedCheque)?(swal({title:"Inward Cheque Clearing",type:"error",text:"The supplied cheque number have not been previously used. Cannot select 'Other return cheque'!"}),!1):!isOtherReturnCheque&&isUsedCheque?(swal({title:"Inward Cheque Clearing",type:"error",text:"The supplied cheque number have already been used!"}),!1):$.inArray(chequeno,AccountChequeLeaves.stopped)!==-1?(swal({title:"Inward Cheque Clearing",type:"error",text:"The supplied cheque number has been stopped!"}),!1):!0:(swal({title:"Inward Cheque Clearing",type:"error",text:"The supplied cheque number does not exist amongst the customer's cheques! Please check the number again."}),!1)}function save(){var form=$("#inward-cheque-form");form.valid()&&runValidations()&&swal({title:"Are you sure?",text:"Inward cheque would be lodged",type:"question",showCancelButton:!0,confirmButtonColor:"#34D027",confirmButtonText:"Yes, continue",cancelButtonText:"No, stop!",cancelButtonColor:"#ff9800",showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(resolve){setTimeout(function(){resolve()},1e3)})}}).then(function(isConfirm){if(isConfirm){var form_data={};$.each(form.serializeArray(),function(index,item){form_data[item.name]=item.value});form_data.casaaccountname=AccountObj.name;form_data.reusecheque=form_data.reusecheque!=undefined?!0:!1;form_data.otherreturn=form_data.otherreturn!=undefined?!0:!1;form_data.chargecot!=undefined?form_data.chargecot=!0:(form_data.chargecot=!1,delete form_data.cotamount);form_data["charge-type"]!=undefined?(delete form_data["charge-type"],form.find("#discount").prop("checked")?(form_data.isdiscountcharge=!0,form_data.isreturncharge=!1):(form_data.isdiscountcharge=!1,form_data.isreturncharge=!0)):(delete form_data.chargeamount,delete form_data.chargepercent,delete form_data.chargeglid);$.ajax(url_path+"/../LodgeInwardCheque",{method:"POST",contentType:"application/json",data:JSON.stringify(form_data)}).then(function(){clearForm();swal({title:"Lodge Inward Request",type:"success",text:"Inward cheque lodged successfully!"});$("#inward-cheque-table").bootstrapTable("refresh");$("#inwardChequeModal").modal("hide")},function(){swal({title:"Lodge Inward Request",type:"error",text:"There was an error lodging the cheque. Please try again."})})}},function(){return})}function clearForm(){var form=$("#inward-cheque-form");form.trigger("reset");form.find("select").trigger("change");utilities.clearDetails();form.find("#amount").trigger("change")}var url_path=window.location.pathname,utilities;url_path.charAt(url_path.length-1)=="/"&&(url_path=url_path.slice(0,url_path.length-1));var products={},chartofaccounts={},ChequeAmount,DiscountChargeObj,ReturnChargeObj,COTObj,AccountObj,AccountCheques,AccountChequeLeaves,AmountDifference,inwardbankcheque={},REQUEST_IN_PROGRESS="request_in_progress";$(document).ready(function(){pullSecondaryData();initSelectTwoConfig();initEventListeners();initFormValidations();initDatePicker();$(".modal").perfectScrollbar()});utilities={inwardDetailFormatter:function(index,row,el){var container=$("<div class='row mx-0'><\/div>");container.append($("<div class='col-xs-12 col-md-6 mb-3 mt-2'><b class='text-muted pull-left'>Discount Ledger:<\/b> <span class='pull-right'>"+utilities.COAFormatter(row.discountglid)+"<\/span><\/div>"));container.append($("<div class='col-xs-12 col-md-6 mb-3 mt-2'><b class='text-muted pull-left'>Transaction Date:<\/b> <span class='pull-right'>"+utilities.dateFormatter(row.transactiondate)+"<\/span><\/div>"));container.append($("<div class='col-xs-12 col-md-6 mb-3'><b class='text-muted pull-left'>Charge COT:<\/b> <span class='pull-right'>"+(row.chargecot?"Yes":"No")+"<\/span><\/div>"));container.append($("<div class='col-xs-12 col-md-6 mb-3'><b class='text-muted pull-left'>Reuse Cheque:<\/b> <span class='pull-right'>"+(row.reusecheque?"Yes":"No")+"<\/span><\/div>"));container.append($("<div class='col-xs-12 col-md-6 mb-2'><b class='text-muted pull-left'>Other Return Cheque:<\/b> <span class='pull-right'>"+(row.chequereturnable?"Yes":"No")+"<\/span><\/div>"));container.append($("<div class='col-xs-12 col-md-6 mb-2'><b class='text-muted pull-left'>Remarks:<\/b> <span class='pull-right'>"+row.remarks+"<\/span><\/div>"));el.append(container)},mandateDetailFormatter:function(index,row,el){var container=$("<div class='row justify-content-space-between mx-0'><\/div>");container.append($("<div class='col-xs-12 col-md-4 mb-3 mt-2'><img alt='signature' src='"+url_path+"/../../img/tcb-spinner.svg'  class='image-fit signature' /><label class='w-100 text-center font-weight-bold'>Signature<\/label><\/div>"));container.append($("<div class='col-xs-12 col-md-4 mb-3 mt-2'><img alt='passport' src='"+url_path+"/../../img/tcb-spinner.svg'  class='image-fit passport' /><label class='w-100 text-center font-weight-bold'>Passport<\/label><\/div>"));container.append($("<div class='col-xs-12 col-md-4 mb-3 mt-2'><img alt='thumbprint' src='"+url_path+"/../../img/tcb-spinner.svg'  class='image-fit thumbprint' /><label class='w-100 text-center font-weight-bold'>Thumbprint<\/label><\/div>"));el.append(container);$.ajax(url_path+"/../LoadMandateDocList/"+row.mandateID).then(function(response){response.length&&(utilities.getMandateSignature(response,el),utilities.getMandatePassport(response,el),utilities.getMandateThumbprint(response,el))})},getMandateSignature:function(docList,el){var docArray=$.grep(docList,function(item){return item.description.trim().toLowerCase()=="signature"});docArray.length==0?el.find(".signature").attr("src","/img/no-image.png"):el.find(".signature").attr("src",url_path+"/../LoadMandateDoc/"+docArray[0].fileID)},getMandatePassport:function(docList,el){var docArray=$.grep(docList,function(item){return item.description.trim().toLowerCase()=="passport"});docArray.length==0?el.find(".passport").attr("src","/img/no-image.png"):el.find(".passport").attr("src",url_path+"/../LoadMandateDoc/"+docArray[0].fileID)},getMandateThumbprint:function(docList,el){var docArray=$.grep(docList,function(item){return item.description.trim().toLowerCase()=="thumbprint"});docArray.length==0?el.find(".thumbprint").attr("src","/img/no-image.png"):el.find(".thumbprint").attr("src",url_path+"/../LoadMandateDoc/"+docArray[0].fileID)},booleanFormatter:function(val){return val?"Yes":"No"},dateFormatter:function(date){return moment(date).format("DD MMMM, YYYY")},COAFormatter:function(value){return chartofaccounts[value]},ChargeCOTSwitch:function(action){var form=$("#inward-cheque-form");action==!0?(form.find("#chargecot").removeAttr("disabled"),form.find("#cot-box, #cot-box > .form-check").removeClass("disabled")):(form.find("[name=cotamount]").val(0),form.find("#chargecot").prop("checked",!1),form.find("#chargecot").attr("disabled",!0),form.find("#cot-box, #cot-box > .form-check").addClass("disabled"))},WriteCOTAmount:function(action){if(action){var COTCharge=COTObj.feeAmount/COTObj.minTransactionAmount*ChequeAmount;AmountDifference=Number(ChequeAmount-COTCharge);$("#inward-cheque-form [name=cotamount]").val(FormatMoney(COTCharge));$("#inward-cheque-form [name=amountdifference]").val(FormatMoney(AmountDifference))}else $("#inward-cheque-form [name=cotamount]").val(0),$("#inward-cheque-form [name=amountdifference]").val(FormatMoney(ChequeAmount))},clearDetails:function(){var form=$("#inward-cheque-form");form.find("#accountno").text("-");form.find("#accountname").text("-");form.find("#balance").text("-");form.find("#productname").text("-");$("#casa-mandate-table").bootstrapTable("removeAll");AccountCheques=REQUEST_IN_PROGRESS;AccountChequeLeaves=REQUEST_IN_PROGRESS},clearCheckBoxes:function(){$("#charges-box").slideUp();$("input[name=charge-type]").prop("checked",!1)},enableDisableOtherReturn:function(action,element){action?(element.removeAttr("disabled"),element.closest(".form-check").parent().removeClass("disabled"),$(".charges-control").slideUp()):(element.prop("checked",!1),element.attr("disabled",!0),element.closest(".form-check").parent().addClass("disabled"),utilities.clearCheckBoxes(),$(".charges-control").slideUp())},initChargeBox:function(charge){var box=$("#charges-box");box.find("#charge-header").text(charge);box.find(".charge-swap").text(charge);box.find("select").val(null).trigger("change");charge=="Discount"?DiscountChargeObj!=undefined&&utilities.populateCharges(DiscountChargeObj,box):ReturnChargeObj!=undefined&&utilities.populateCharges(ReturnChargeObj,box);$("#charges-box").slideDown()},getProductName:function(id){return products[id].productName},filterMandates:function(mandates){return $.grep(mandates,function(item){return item.isDeleted==!1})},populateCharges:function(chargeObj,container){container.find("#chargeglid").val(chargeObj.accountledgerid).trigger("change");container.find("#chargepercent").val(chargeObj.percentage);utilities.calculateChargeAmount()},calculateChargeAmount:function(){var rate=Number($("#charges-box").find("#chargepercent").val()),charge;if(rate==NaN)return $("#charges-box").find("#chargeamount").val("");charge=rate/100*Math.abs(AmountDifference);utilities.WriteInputAmount(charge,$("#charges-box").find("#chargeamount"))},WriteInputAmount:function(amount,domElement){amount>=0?domElement.removeClass("text-danger").addClass("text-success").val(FormatMoney(amount)):domElement.removeClass("text-success").addClass("text-danger").val(FormatMoney(amount));domElement.trigger("change")},WriteAmount:function(balance,domText){balance>=0?domText.removeClass("text-danger").addClass("text-success").text(FormatMoney(balance)):domText.removeClass("text-success").addClass("text-danger").text(FormatMoney(balance))}};